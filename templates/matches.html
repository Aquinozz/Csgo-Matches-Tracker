{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>{{ titulo }}</h1>
    <p class="subtitle">Dados atualizados da PandaScore</p>
</div>

<div class="matches-grid">
    {% for match in matches %}
    <div class="match-card">
        
        <div class="league-info">
            <img src="{{ match.league.image_url or 'https://via.placeholder.com/20' }}" alt="Liga" onerror="this.parentElement.classList.add('broken')">
            <span>{{ match.league.name }} - {{ match.serie.full_name }}</span>
        </div>

        <div class="match-main">
            <div class="team">
                <div class="logo-wrapper">
                    {% if match.opponents[0] %}
                        <img src="{{ match.opponents[0].opponent.image_url or 'https://via.placeholder.com/80?text=?' }}" alt="Logo" onerror="this.parentElement.classList.add('broken')">
                    {% else %}
                        <div class="no-logo">?</div>
                    {% endif %}
                </div>
                <span class="team-name">
                    {{ match.opponents[0].opponent.name if match.opponents[0] else "TBD" }}
                </span>
            </div>

            <div class="match-status">
    {# Caso 1: Partida Finalizada (Past) #}
    {% if match.status == 'finished' or match.status == 'past' or match.winner_id != None %}
        <div class="score">
            {% set s1 = 0 %}
            {% set s2 = 0 %}

            {# Tentativa A: Pela lista de resultados (mais comum) #}
            {% if match.results and match.results|length >= 2 %}
                {% for res in match.results %}
                    {% if match.opponents|length >= 2 %}
                        {% if res.team_id == match.opponents[0].opponent.id %}{% set s1 = res.score %}{% endif %}
                        {% if res.team_id == match.opponents[1].opponent.id %}{% set s2 = res.score %}{% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            {# Tentativa B: Fallback se o score ainda for 0 - Verificando o vencedor direto #}
            {% if s1 == 0 and s2 == 0 and match.winner_id != None %}
                {% if match.winner_id == match.opponents[0].opponent.id %} {% set s1 = 'W' %} {% set s2 = 'L' %}
                {% else %} {% set s1 = 'L' %} {% set s2 = 'W' %} {% endif %}
            {% endif %}
            
            <span class="score-number">{{ s1 }}</span>
            <span class="score-divider">:</span>
            <span class="score-number">{{ s2 }}</span>
        </div>
        <span class="finished-label">Finalizado</span>

    {# Caso 2: Partida Ao Vivo #}
    {% elif match.status == 'running' %}
        <span class="badge-live">LIVE</span>
        <div class="score live-score">
            {{ match.results[0].score if match.results else 0 }} : {{ match.results[1].score if match.results else 0 }}
        </div>

    {# Caso 3: Partida Futura #}
    {% else %}
        <span class="vs-badge">VS</span>
        <div class="score-tbd">Agendada</div>
    {% endif %}
</div>

            <div class="team">
                <div class="logo-wrapper">
                    {% if match.opponents[1] %}
                        <img src="{{ match.opponents[1].opponent.image_url or 'https://via.placeholder.com/80?text=?' }}" alt="Logo" onerror="this.parentElement.classList.add('broken')">
                    {% else %}
                        <div class="no-logo">?</div>
                    {% endif %}
                </div>
                <span class="team-name">
                    {{ match.opponents[1].opponent.name if match.opponents[1] else "TBD" }}
                </span>
            </div>
        </div>

        <div class="match-footer">
            <i class="calendar-icon">ðŸ“…</i>
            <span>{% if match.begin_at %}
            {{ match.begin_at | br_time }}
        {% elif match.scheduled_at %}
            {{ match.scheduled_at | br_time }}
        {% else %}
            Data a definir
        {% endif %}
    </span>

        </div>
    </div>
    {% else %}
    <div class="no-matches">
        <p>Nenhuma partida encontrada para esta categoria no momento.</p>
        <a href="/" class="btn-outline">Voltar para Home</a>
    </div>
    {% endfor %}
</div>
{% endblock %}